<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YT Analyzer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #007aff;
      --color-secondary: #34c759;
      --color-alert: #ff3b30;
      --color-neutral: #a9a9b0;
      --color-bg-dark: #1e1e2c;
      --glass-blur: 20px;
      --glass-bg: rgba(255, 255, 255, 0.08);
    }
    body { font-family: 'Inter', sans-serif; background:#1e1e2c; color:#fff; margin:0; padding:0; min-height:100vh; display:flex; justify-content:center; }
    .container { width:100%; max-width:1100px; padding:24px; box-sizing:border-box; }
    h1 { text-align:center; color:var(--color-primary); margin-bottom:18px; text-shadow:0 0 10px rgba(0,122,255,0.4); }
    .input-area { display:flex; gap:12px; justify-content:center; margin-bottom:18px; }
    input[type="text"] { width:100%; max-width:760px; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.03); color:#fff; outline:none; }
    button { padding:10px 18px; border-radius:10px; border:none; background:var(--color-primary); color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:wait; }
    .layout { display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap; }
    .video-panel { flex:2; min-width:300px; }
    .transcript-panel { flex:1; min-width:280px; max-height:460px; overflow:auto; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; border:1px solid rgba(255,255,255,0.04); }
    iframe { width:100%; height:360px; border-radius:10px; border:2px solid var(--color-primary); }
    .comment-area { margin-top:16px; padding:12px; background:var(--glass-bg); border-radius:12px; border:1px solid rgba(255,255,255,0.06); }
    .columns { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:200px; }
    .col h3 { margin:0 0 8px 0; }
    .box { max-height:180px; overflow:auto; padding:8px; background:rgba(0,0,0,0.15); border-radius:8px; }
    .stats { margin-top:8px; color:#cfcfcf; font-size:0.9em; }
    .ai-chat { margin-top:18px; padding:12px; border-radius:10px; background:rgba(255,255,255,0.03); }
    .chat-log { max-height:160px; overflow:auto; margin-bottom:8px; }
    .chat-entry { margin:6px 0; }
    .user-msg { text-align:right; }
    .ai-msg { display:flex; gap:10px; align-items:flex-start; }
    .gemini { width:26px; height:26px; border-radius:50%; background:linear-gradient(135deg,#007aff,#5ac8fa); }
    .error { color:var(--color-alert); text-align:center; margin-top:8px; display:none; }
    @media (max-width: 900px) { .layout { flex-direction:column; } iframe { height:240px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>YT Analyzer</h1>

    <div class="input-area">
      <input id="videoUrl" type="text" placeholder="Paste YouTube URL (watch, youtu.be, shorts)"/>
      <button id="submitBtn">Analyze Transcript & Comments</button>
    </div>

    <div id="errorMsg" class="error"></div>

    <div class="layout">
      <div class="video-panel">
        <iframe id="videoFrame" allowfullscreen src=""></iframe>
      </div>

      <div class="transcript-panel" id="transcripts">
        <em>Transcript & AI summary will appear here after analysis.</em>
      </div>
    </div>

    <div class="comment-area">
      <h2>Comment Sentiment Matrix</h2>
      <div class="columns">
        <div class="col">
          <h3 style="color:var(--color-secondary)">Positive</h3>
          <div id="commentsPositive" class="box">—</div>
          <div id="positiveStats" class="stats"></div>
        </div>
        <div class="col">
          <h3 style="color:var(--color-alert)">Negative</h3>
          <div id="commentsNegative" class="box">—</div>
          <div id="negativeStats" class="stats"></div>
        </div>
        <div class="col">
          <h3 style="color:var(--color-neutral)">Neutral</h3>
          <div id="commentsNeutral" class="box">—</div>
          <div id="neutralStats" class="stats"></div>
        </div>
      </div>

      <div class="ai-chat">
        <h3>Ask Gemini AI about this video</h3>
        <div id="chatLog" class="chat-log"></div>
        <div style="display:flex;gap:8px;">
          <input id="aiQuestion" type="text" placeholder="Ask something about this video..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;" />
          <button id="askBtn">Ask</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // === CONFIG ===
  // When testing locally keep localhost; replace with your Render URL when deployed.
  const API_BASE = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1")
    ? "http://localhost:5000"
    : "https://RENDER_BACKEND_URL"; // <<-- Replace RENDER_BACKEND_URL with your Render service domain

  function extractVideoId(url) {
    if (!url) return null;
    // try common forms
    let m = url.match(/(?:v=|youtu\.be\/|\/shorts\/)([a-zA-Z0-9_-]{11})/);
    return m ? m[1] : null;
  }

  const submitBtn = document.getElementById('submitBtn');
  const videoFrame = document.getElementById('videoFrame');
  const transcriptsDiv = document.getElementById('transcripts');
  const commentsPositive = document.getElementById('commentsPositive');
  const commentsNegative = document.getElementById('commentsNegative');
  const commentsNeutral = document.getElementById('commentsNeutral');
  const chatLog = document.getElementById('chatLog');
  const errorMsg = document.getElementById('errorMsg');

  submitBtn.addEventListener('click', async () => {
    const url = document.getElementById('videoUrl').value.trim();
    const vid = extractVideoId(url);
    if (!vid) {
      errorMsg.textContent = "Invalid YouTube URL.";
      errorMsg.style.display = "block";
      return;
    }
    errorMsg.style.display = "none";
    submitBtn.disabled = true;
    submitBtn.textContent = "Processing...";

    videoFrame.src = `https://www.youtube.com/embed/${vid}`;
    transcriptsDiv.innerHTML = "<em>Loading transcript and summary...</em>";
    commentsPositive.innerHTML = commentsNegative.innerHTML = commentsNeutral.innerHTML = "<em>Fetching comments...</em>";

    try {
      const res = await fetch(`${API_BASE}/process`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ video_url: url })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Server error");

      // show summary
      transcriptsDiv.innerHTML = "";
      if (data.summary) {
        const box = document.createElement('div');
        box.style.padding = "10px";
        box.style.borderRadius = "8px";
        box.style.background = "rgba(255,255,255,0.02)";
        box.style.marginBottom = "10px";
        box.innerHTML = `<strong>AI Summary</strong><p style="margin:8px 0 0 0">${data.summary}</p>`;
        transcriptsDiv.appendChild(box);
      }

      if (data.transcripts && Array.isArray(data.transcripts)) {
        data.transcripts.forEach(t => {
          const d = document.createElement('div');
          d.className = 'transcript-item';
          const time = new Date((t.start || 0) * 1000).toISOString().substr(11,8);
          d.innerHTML = `<span style="color:var(--color-secondary);font-weight:700;margin-right:8px">${time}</span> ${t.text || ''}`;
          transcriptsDiv.appendChild(d);
        });
      }

      commentsPositive.innerHTML = (data.comments_positive || []).map(c => `<div>${c}</div>`).join('') || "<em>No positive comments.</em>";
      commentsNegative.innerHTML = (data.comments_negative || []).map(c => `<div>${c}</div>`).join('') || "<em>No negative comments.</em>";
      commentsNeutral.innerHTML = (data.comments_neutral || []).map(c => `<div>${c}</div>`).join('') || "<em>No neutral comments.</em>";

      document.getElementById('positiveStats').innerText = `Count: ${data.comment_counts.positive} | ${data.comment_percentages.positive}%`;
      document.getElementById('negativeStats').innerText = `Count: ${data.comment_counts.negative} | ${data.comment_percentages.negative}%`;
      document.getElementById('neutralStats').innerText = `Count: ${data.comment_counts.neutral} | ${data.comment_percentages.neutral}%`;

    } catch (err) {
      transcriptsDiv.innerHTML = `<div style="color:var(--color-alert)">Error: ${err.message}</div>`;
      console.error(err);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Analyze Transcript & Comments";
    }
  });

  document.getElementById('askBtn').addEventListener('click', async () => {
    const question = document.getElementById('aiQuestion').value.trim();
    const videoUrl = document.getElementById('videoUrl').value.trim();
    if (!question || !videoUrl) return;
    const userDiv = document.createElement('div'); userDiv.className = 'chat-entry user-msg'; userDiv.textContent = question; chatLog.appendChild(userDiv);

    const aiDiv = document.createElement('div'); aiDiv.className = 'chat-entry ai-msg'; aiDiv.innerHTML = `<div class="gemini"></div><div>Thinking...</div>`; chatLog.appendChild(aiDiv);
    document.getElementById('aiQuestion').value = '';

    try {
      const res = await fetch(`${API_BASE}/ask`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ video_url: videoUrl, question })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "AI error");
      aiDiv.innerHTML = `<div class="gemini"></div><div>${data.answer}</div>`;
    } catch (err) {
      aiDiv.innerHTML = `<div class="gemini"></div><div style="color:var(--color-alert)">Error: ${err.message}</div>`;
    }
  });
</script>
</body>
</html>
